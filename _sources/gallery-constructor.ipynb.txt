{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "import base64\n",
    "import dataclasses\n",
    "import json\n",
    "import os\n",
    "import pathlib\n",
    "import random\n",
    "import shutil\n",
    "from textwrap import dedent\n",
    "\n",
    "import matplotlib.image\n",
    "import matplotlib.pyplot as plt\n",
    "import pandas as pd\n",
    "import yaml"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "descriptions = \"\"\"\n",
    "Sed metus purus, tempus sed orci non, efficitur volutpat enim. Aliquam purus erat, laoreet eu dui ut, posuere pretium ex. Integer et pellentesque nulla. Nunc ultricies lorem diam, sit amet ultricies lorem maximus eu. Sed eleifend iaculis ornare. Pellentesque dignissim quam in nisi mattis luctus ac at ex. Etiam vitae enim ut arcu condimentum interdum. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque non magna sed tellus facilisis semper non consectetur est. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras suscipit lectus enim, eu rutrum mi mollis non. Curabitur eu cursus dolor.\n",
    "\n",
    "Pellentesque ultrices leo vitae venenatis dignissim. Pellentesque vel ullamcorper lorem, ut fermentum orci. Curabitur bibendum varius tellus vitae auctor. Nullam sem lacus, vulputate quis arcu ac, laoreet sollicitudin velit. Proin lectus tortor, efficitur rutrum faucibus eget, eleifend eu velit. Vestibulum vel faucibus leo. In nec hendrerit dui. Aenean et venenatis risus. Curabitur quis posuere nunc. Nulla nec egestas massa. Sed eget aliquam turpis. Aenean consequat tellus non dolor accumsan, vitae pellentesque lacus posuere. Sed sed felis a turpis vestibulum pretium ac nec est. Proin semper erat dolor, eget elementum lorem convallis vel. Aliquam ante arcu, convallis ac velit aliquam, lacinia lobortis ex. Suspendisse metus sem, malesuada ac massa a, dignissim porta lectus.\n",
    "\n",
    "Vestibulum id vestibulum diam, eu sollicitudin nunc. Mauris in varius velit. Maecenas lacus tortor, ultrices eget arcu non, ultrices ullamcorper nisl. Morbi auctor purus hendrerit leo tincidunt gravida. Ut a dignissim nisl. Proin ac venenatis eros, eget pharetra velit. Etiam dapibus nulla vitae aliquet varius. Vivamus eget mattis purus, eu bibendum ante. Ut efficitur orci elementum ligula facilisis tempus. Nulla at est eu nulla accumsan bibendum a sit amet enim. Aenean vestibulum et neque id tincidunt.\n",
    "\n",
    "Aliquam erat volutpat. Etiam pulvinar erat id metus sodales, convallis vehicula leo molestie. In in consectetur augue, ut venenatis mauris. Morbi in massa volutpat, consequat ligula vel, hendrerit erat. Aliquam eget magna dictum, molestie nibh in, accumsan diam. Suspendisse sed varius tortor. Nam consectetur ultricies velit sit amet iaculis.\n",
    "\n",
    "Vivamus tincidunt quam eget erat maximus maximus ut pulvinar diam. In libero magna, consequat ac malesuada quis, dignissim in mi. Phasellus placerat massa sed justo volutpat scelerisque. Mauris ultrices consectetur sodales. Nulla ut feugiat urna. Morbi feugiat ipsum sit amet consequat porttitor. Proin nec ultricies elit.\n",
    "\n",
    "Nulla at finibus sem. Nullam pharetra sem eget tempor molestie. Maecenas ac diam eu arcu euismod venenatis. Cras iaculis efficitur leo vitae iaculis. Ut in pretium magna. Sed vestibulum vestibulum mi eget pharetra. Mauris quis sapien eget neque aliquet cursus. Vivamus gravida felis risus. Proin efficitur quis ex quis eleifend. Nam ut felis a eros blandit vulputate vitae sed tortor. Phasellus interdum maximus purus, et porta tortor sollicitudin vitae. Praesent a mauris sollicitudin, viverra tortor ac, consequat lacus. Etiam scelerisque est erat, sed elementum eros aliquet sed.\n",
    "\n",
    "In dapibus sit amet lectus at fermentum. Nullam aliquam justo arcu, ut lobortis risus porttitor eget. Vivamus eu mauris quis ex hendrerit facilisis. Aliquam ac arcu nunc. Vivamus maximus ex vitae ultricies iaculis. Vivamus ornare sodales tellus nec vulputate. In nibh lorem, lobortis vitae nibh a, egestas dignissim ante.\n",
    "\n",
    "Cras commodo magna ac leo vestibulum, vitae porttitor dui faucibus. Vestibulum vel semper erat. Ut facilisis massa tortor, eu sodales tortor pulvinar in. Cras congue, eros nec sagittis varius, orci diam interdum ligula, eget pulvinar erat purus ut mauris. Etiam fermentum congue maximus. Maecenas sed fringilla ex. Nunc quis euismod nibh. Curabitur viverra quam vel pretium tristique. Nam eu sem id quam sollicitudin blandit eget vel sem. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia curae; Vestibulum nec libero ut velit dignissim feugiat. Integer eleifend arcu fermentum mi ullamcorper dignissim. Aenean posuere arcu eget viverra varius. Morbi ut elit vitae sapien tempus porttitor. In sed convallis sem, sed semper sapien. Lorem ipsum dolor sit amet, consectetur adipiscing elit.\n",
    "\n",
    "Mauris auctor malesuada lectus, in dignissim nisi imperdiet ut. Duis lacinia libero tellus, sed tempor erat blandit in. Sed nisl orci, ultricies quis leo id, mattis euismod magna. Duis luctus, nibh id cursus lobortis, tellus risus rutrum est, vitae hendrerit ex turpis in nibh. Sed lobortis nisl ut dolor aliquet, at aliquet orci cursus. Cras vitae justo ullamcorper, fringilla quam vel, sollicitudin augue. In vitae porttitor ex. Vivamus ac nunc elit. Aenean sed ultricies ipsum. Curabitur tristique auctor libero, sed pulvinar felis ornare sed. Duis volutpat mauris vitae eros varius faucibus. Integer posuere rhoncus faucibus. Aliquam fringilla placerat eros nec sollicitudin.\n",
    "\n",
    "Quisque efficitur felis arcu, ultricies aliquet turpis maximus ut. Cras quis pulvinar velit. Vestibulum pretium pretium felis, ut consectetur eros iaculis eu. Cras massa nisi, varius eu ante eget, interdum condimentum massa. Maecenas imperdiet tristique sagittis. Interdum et malesuada fames ac ante ipsum primis in faucibus. Cras gravida orci at mi pretium consectetur. Pellentesque eget eleifend neque, eget tempor dui. Mauris sit amet pretium justo, nec condimentum nibh. Duis tristique est lorem. Nulla ut tincidunt neque. Aenean rhoncus ultrices lorem, sed elementum massa sollicitudin vel.\n",
    "\"\"\".split(\n",
    "    \"\\n\\n\"\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [],
   "source": [
    "DOC_SRC = pathlib.Path(\".\").absolute()\n",
    "default_img_loc = DOC_SRC / '_static/sphinx-logo.png'\n",
    "thumbnail_dir = DOC_SRC / '_static/thumbnails'\n",
    "thumbnail_dir.mkdir(parents=True, exist_ok=True)\n",
    "\n",
    "\n",
    "def create_thumbnail(infile, width=275, height=275, cx=0.5, cy=0.5, border=4):\n",
    "    \"\"\"Overwrites `infile` with a new file of the given size\"\"\"\n",
    "    im = matplotlib.image.imread(infile)\n",
    "    rows, cols = im.shape[:2]\n",
    "    size = min(rows, cols)\n",
    "    if size == cols:\n",
    "        xslice = slice(0, size)\n",
    "        ymin = min(max(0, int(cx * rows - size // 2)), rows - size)\n",
    "        yslice = slice(ymin, ymin + size)\n",
    "    else:\n",
    "        yslice = slice(0, size)\n",
    "        xmin = min(max(0, int(cx * cols - size // 2)), cols - size)\n",
    "        xslice = slice(xmin, xmin + size)\n",
    "    thumb = im[yslice, xslice]\n",
    "    thumb[:border, :, :3] = thumb[-border:, :, :3] = 0\n",
    "    thumb[:, :border, :3] = thumb[:, -border:, :3] = 0\n",
    "\n",
    "    dpi = 100\n",
    "    fig = plt.figure(figsize=(width / dpi, height / dpi), dpi=dpi)\n",
    "\n",
    "    ax = fig.add_axes([0, 0, 1, 1], aspect='auto', frameon=False, xticks=[], yticks=[])\n",
    "    ax.imshow(thumb, aspect='auto', resample=True, interpolation='bilinear')\n",
    "    fig.savefig(infile, dpi=dpi)\n",
    "    plt.close(fig)\n",
    "    return fig\n",
    "\n",
    "\n",
    "@dataclasses.dataclass\n",
    "class NotebookInfo:\n",
    "    filepath: pathlib.Path\n",
    "    default_img_loc: pathlib.Path = default_img_loc\n",
    "    thumbnail_dir: pathlib.Path = thumbnail_dir\n",
    "\n",
    "    def __post_init__(self):\n",
    "        self.thumbnail_dir.mkdir(parents=True, exist_ok=True)\n",
    "        self.png_path = self.thumbnail_dir / f'{self.filepath.stem}.png'\n",
    "        with open(self.filepath) as fid:\n",
    "            self.json_source = json.load(fid)\n",
    "            self.gen_preview()\n",
    "        relative_to_dir = DOC_SRC\n",
    "\n",
    "        nb_id = f'../{self.filepath.relative_to(relative_to_dir).parent}/{self.filepath.stem}'\n",
    "        self.info = {\n",
    "            'thumbnail': f\"../{self.png_path.relative_to(relative_to_dir).as_posix()}\",\n",
    "            'notebook': f\"../{self.filepath.relative_to(relative_to_dir).as_posix()}\",\n",
    "            'title': self.extract_title(),\n",
    "            'url': f'{nb_id}.html',\n",
    "            'id': nb_id,\n",
    "            'tags': list(self.filepath.relative_to(DOC_SRC / 'notebooks').parent.parts[:]),\n",
    "            'description': random.choice(descriptions)[:200].strip(),\n",
    "        }\n",
    "\n",
    "    def gen_preview(self):\n",
    "        preview = self.extract_preview_pic()\n",
    "        if preview is not None:\n",
    "            with open(self.png_path, 'wb') as buff:\n",
    "                buff.write(preview)\n",
    "        else:\n",
    "            shutil.copy(self.default_img_loc, self.png_path)\n",
    "\n",
    "        create_thumbnail(self.png_path)\n",
    "\n",
    "    def extract_preview_pic(self):\n",
    "        \"\"\"Use the last image in the notebook as preview pic\"\"\"\n",
    "        pic = None\n",
    "        for cell in self.json_source['cells']:\n",
    "            for output in cell.get('outputs', []):\n",
    "                if 'image/png' in output.get('data', []):\n",
    "                    pic = output['data']['image/png']\n",
    "        if pic is not None:\n",
    "            return base64.b64decode(pic)\n",
    "        return None\n",
    "\n",
    "    def extract_title(self):\n",
    "        for cell in self.json_source['cells']:\n",
    "            if cell['cell_type'] == 'markdown':\n",
    "                rows = [row.strip() for row in cell['source'] if row.strip()]\n",
    "                for row in rows:\n",
    "                    if row.startswith('# '):\n",
    "                        return row[2:].replace(':', '-')\n",
    "        return self.filepath.stem.replace('_', ' ').replace(':', '-')\n",
    "\n",
    "\n",
    "def build_gallery():\n",
    "    notebooks_path = DOC_SRC / 'notebooks'\n",
    "    notebooks = sorted(\n",
    "        [notebook for notebook in notebooks_path.glob('**/*.ipynb') if 'checkpoint' not in notebook.name]\n",
    "    )\n",
    "    entries = [NotebookInfo(note).info for note in notebooks]\n",
    "    df = pd.DataFrame(entries).sort_values(by=['title'])\n",
    "    entries = df.to_dict(orient='records')\n",
    "    with open(DOC_SRC / 'galleries/ notebook-gallery.yaml', 'w') as fid:\n",
    "        yaml.dump(entries, fid)\n",
    "\n",
    "    panels_body = []\n",
    "    for entry in entries:\n",
    "        x = f\"\"\"\\\n",
    "        ---\n",
    "        :img-top: {entry[\"thumbnail\"]}\n",
    "        +++\n",
    "        **{entry['title']}**\n",
    "        \n",
    "        {entry['description'][:50]} ...\n",
    "\n",
    "        {{link-badge}}`{entry[\"url\"]},\"rendered-notebook\",cls=badge-secondary text-white float-left p-2 mr-1,tooltip={entry[\"title\"].replace(\",\", \"\")}`\n",
    "        \"\"\"\n",
    "\n",
    "        panels_body.append(x)\n",
    "\n",
    "    panels_body = \"\\n\".join(panels_body)\n",
    "\n",
    "    gallery_content = f'''# Notebook Gallery\n",
    "````{{panels}}\n",
    ":container: full-width\n",
    ":column: text-left col-6 col-lg-4\n",
    ":card: +my-2\n",
    ":img-top-cls: w-75 m-auto p-2\n",
    ":body: d-none\n",
    "\n",
    "{dedent(panels_body)}\n",
    "````\n",
    "'''\n",
    "    with open(DOC_SRC / 'galleries/notebook-gallery.md', 'w') as fid:\n",
    "        fid.write(gallery_content)\n",
    "\n",
    "\n",
    "build_gallery()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
